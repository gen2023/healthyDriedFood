(()=>{"use strict";let e=[],t=[];window.NevigenNovaposhta={calculation:function(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!e||!t||!o)return!1;let n=document.querySelector('[data-nevigen-novaposhta-container="'+o+'"]');if(n){let i=n.querySelector('[data-nevigen-novaposhta-message="'+o+'"]'),s=new FormData;if(e.value){let r=n.querySelector('[name="params['+o+'][nevigen_novaposhta_postcode]"]');if(r){if(!window.NevigenNovaposhta.checkPostcode(r,o))return!1;if(s.set("postcode",r.value),s.set("value",e.value),"warehouse"===t||"postomat"===t){if(window.NevigenOneStepCheckoutClass&&!1===a)return!1;s.set("type",t)}else s.set("type","doors");Joomla.removeMessages(i)}}window.NevigenNovaposhta.sendAjax("post","calculation",s).then(e=>{e.data&&e.data.price_string?window.NevigenNovaposhta.setPrice(o,e.data.price_string):window.NevigenNovaposhta.setPrice(o,0)}).catch(e=>{window.NevigenNovaposhta.setError(o,e.message)})}},validPostcode:(e,t)=>{if(e){e.value=e.value.replace(/[^.\d]+/g,"").replace(/^([^.]*\.)|\./g,"$1"),e.value.length>5&&(e.value=e.value.slice(0,-1));let o=e.getAttribute("data-nevigen-novaposhta");5===e.value.length&&("pickup"===o?(window.NevigenNovaposhta.setPreloader(),window.NevigenNovaposhta.getWarehouses(e,t),window.NevigenNovaposhta.removePreloader()):"postomat"===o?(window.NevigenNovaposhta.setPreloader(),window.NevigenNovaposhta.getPostomat(e,t),window.NevigenNovaposhta.removePreloader()):"courier"===o&&(window.NevigenNovaposhta.setPreloader(),window.NevigenNovaposhta.validCourier(e,"postcode",t),window.NevigenNovaposhta.removePreloader()))}},checkPostcode:(e,t)=>{if(e&&t)return e.value.length>=5||(window.NevigenNovaposhta.setError(t,Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_ERROR_POSTCODE")),!1)},searchCity:(e,o)=>{if(e&&o){let a=document.querySelector('[name="params['+o+'][nevigen_novaposhta_postcode]"]'),n=e.getAttribute("name");if(3===e.value.length){a&&(a.value="");let i=new FormData;i.set("value",e.value),window.NevigenNovaposhta.sendAjax("post","searchCity",i).then(e=>{"object"==typeof e.data&&(window.NevigenNovaposhta.initAutoComplete(n,e.data),t[n]&&(t[n].start(),t[n].input.addEventListener("selection",e=>{let a=e.detail.selection.value;t[n].input.value=a.name,window.NevigenNovaposhta.setPostcodeByRef(a.ref,o)})))}).catch(e=>{a&&(a.value=""),window.NevigenNovaposhta.setError(o,e.message)})}else if(3>e.value.length&&t[n]&&t[n].data.src.length>0){t[n].data.src=[],t[n].start(),a&&(a.value="");let e=document.querySelector('[name="params['+o+'][nevigen_novaposhta_street]"]');if(e){let a=e.getAttribute("name");t[a]&&(t[a].data.src=[],t[a].start()),window.NevigenNovaposhta.disabledFields(o,["street","house","apartment"])}}return!0}},setPostcodeByRef:(e,t)=>{if(!e||!t)return!1;let o=new FormData;o.set("ref",e),window.NevigenNovaposhta.sendAjax("post","getPostcodeByRef",o).then(e=>{if(e.data){let o=document.querySelector('[data-nevigen-novaposhta-container="'+t+'"]');if(o){let a=o.querySelector('[name="params['+t+'][nevigen_novaposhta_postcode]"]');if(a){a.value=e.data,a.dispatchEvent(new Event("change",{bubbles:!0}));let o=a.getAttribute("data-nevigen-novaposhta");window.NevigenNovaposhta.validPostcode(a,t),"courier"===o&&window.NevigenNovaposhta.validCourier(a,"street",t)}}}}).catch(e=>{window.NevigenNovaposhta.setError(t,e.message)})},getWarehouses:(e,t)=>{if(!e||!t)return!1;if(!window.NevigenNovaposhta.checkPostcode(e,t))return!1;let o=document.querySelector('[data-nevigen-novaposhta-container="'+t+'"]'),a="nevigen_novaposhta_postcode_send_warehouse",n=window.NevigenNovaposhta.getCookie(a);if(""===n||n!==e.value){window.NevigenNovaposhta.setCookie(a,e.value);let n=o.querySelector('select[name="params['+t+'][nevigen_novaposhta_warehouse]"]');n&&(n.value="",n.setAttribute("disabled",""),window.NevigenNovaposhta.initSelect(t,"warehouse",[]));let i=new FormData;i.set("postcode",e.value),window.NevigenNovaposhta.sendAjax("post","getWarehouses",i).then(e=>{"object"==typeof e.data?(n&&n.removeAttribute("disabled"),window.NevigenNovaposhta.initSelect(t,"warehouse",e.data)):window.NevigenNovaposhta.setPrice(t,0)}).catch(e=>{window.NevigenNovaposhta.setError(t,e.message)})}},getPostomat:(e,t)=>{if(!e||!t)return!1;if(!window.NevigenNovaposhta.checkPostcode(e,t))return!1;let o=document.querySelector('[data-nevigen-novaposhta-container="'+t+'"]'),a="nevigen_novaposhta_postcode_send_postomat",n=window.NevigenNovaposhta.getCookie(a);if(""===n||n!==e.value){window.NevigenNovaposhta.setCookie(a,e.value);let n=o.querySelector('select[name="params['+t+'][nevigen_novaposhta_postomat]"]');n&&(n.value="",n.setAttribute("disabled",""),window.NevigenNovaposhta.initSelect(t,"postomat",[]));let i=new FormData;i.set("postcode",e.value),window.NevigenNovaposhta.sendAjax("post","getPostomat",i).then(e=>{"object"==typeof e.data?(n&&n.removeAttribute("disabled"),window.NevigenNovaposhta.initSelect(t,"postomat",e.data)):window.NevigenNovaposhta.setPrice(t,0)}).catch(e=>{window.NevigenNovaposhta.setError(t,e.message)})}},initSelect:(t,o,a)=>{if(!t||!o)return!1;e[t]||(e[t]=null);let n=document.querySelector('[data-nevigen-novaposhta-container="'+t+'"]');if(n){let i={position:"bottom",noResultsText:Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_ERROR_RESULTS"),noChoicesText:Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_ERROR_RESULTS"),placeholderValue:Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_PLACEHOLDER_WAREHOUSE"),searchPlaceholderValue:Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_PLACEHOLDER_WAREHOUSE")};if("object"==typeof a&&e[t])if("object"==typeof e[t])if(0===a.length){e[t].removeActiveItems(),e[t].clearChoices(),e[t].disable();let a=n.querySelector('[name="params['+t+"][nevigen_novaposhta_"+o+']"]');if(a){a=a.closest(".choices__inner");let e=a.querySelector(".choices__list--single");e&&(e.innerText=Joomla.Text._("ADDON_NEVIGEN_NOVAPOSHTA_PLACEHOLDER_"+o))}}else e[t].setChoices(a,"value","label",!0),e[t].enable();else{let s=n.querySelector('[name="params['+t+"][nevigen_novaposhta_"+o+']"]');s&&(e[t]=new Choices(s,i),0!==a.length&&(e[t].setChoices(a,"value","label",!0),e[t].enable()))}else{let a=n.querySelectorAll('[name="params['+t+"][nevigen_novaposhta_"+o+']"]');a.length>0&&a.forEach(o=>{null===e[t]||"object"==typeof e[t]&&e[t].destroy(),e[t]=new Choices(o,i)})}}},initAutoComplete:(e,o)=>!!e&&(t[e]?(t[e].data.src=o,t[e].start(),!0):void(t[e]=new autoComplete({wrapper:!1,data:{src:o,keys:["name"]},selector:'input[name="'+e+'"]',resultsList:{maxResults:1e3,noResults:!0},resultItem:{highlight:!0},events:{input:{focus(){t[e].input.value.length&&t[e].start()}}}}))),validCourier:(e,t,o)=>{if(!e||!t||!o)return!1;let a=document.querySelector('[data-nevigen-novaposhta-container="'+o+'"]');if(a){let n=a.querySelector('[name="params['+o+'][nevigen_novaposhta_postcode]"]');if(n){if(!window.NevigenNovaposhta.checkPostcode(n,o))return window.NevigenNovaposhta.disabledFields(o,["street","house","apartment"]),!1;let i=a.querySelector('[name="params['+o+"][nevigen_novaposhta_"+t+']"]'),s=window.NevigenNovaposhta.getCookie("nevigen_novaposhta_postcode_send");i&&("street"===t?(""!==s&&s===n.value||(i.value=""),window.NevigenNovaposhta.disabledFields(o,["house","apartment"]),window.NevigenNovaposhta.calculation(n,"courier",o)):"house"===t&&window.NevigenNovaposhta.disabledFields(o,["house","apartment"]),e.value?i.removeAttribute("disabled"):(i.value="",i.setAttribute("disabled","")))}}},getStreets:(e,o)=>{if(!e||!o)return!1;let a=e.getAttribute("name");if(3===e.value.length){let n=document.querySelector('[name="params['+o+'][nevigen_novaposhta_postcode]"]');if(n){if(!window.NevigenNovaposhta.checkPostcode(n,o))return window.NevigenNovaposhta.disabledFields(o,["street","house","apartment"]),!1;let i=new FormData;i.set("postcode",n.value),i.set("value",e.value),window.NevigenNovaposhta.sendAjax("post","getStreets",i).then(n=>{"object"==typeof n.data?(window.NevigenNovaposhta.initAutoComplete(a,n.data),t[a]&&(t[a].start(),t[a].input.addEventListener("selection",n=>{t[a].input.value=n.detail.selection.value.name,window.NevigenNovaposhta.validCourier(e,"house",o)}))):window.NevigenNovaposhta.setPrice(o,0)}).catch(e=>{window.NevigenNovaposhta.setError(o,e.message)})}}else 3>e.value.length&&t[a]&&t[a].data.src.length>0&&(t[a].data.src=[],t[a].start(),window.NevigenNovaposhta.disabledFields(o,["house","apartment"]))},disabledFields:(e,t)=>{if(!e||!t||0===t.length)return!1;t.forEach(t=>{let o=document.querySelector('[name="params['+e+"][nevigen_novaposhta_"+t+']"]');o&&(o.value="",o.setAttribute("disabled",""))})},setPrice:(e,t)=>{if(!e)return!1;let o=document.querySelector('[data-shipping_id="'+e+'"]');if(o){let e=document.querySelector('label[for="shipping_method_'+o.value+'"]'),a=document.querySelector('[data-nevigen-onestepcheckout-shipping="'+o.valu+'"]');if(e){let o=e.querySelector(".shipping_price"),n=e.querySelector(".nvg_shipping_cost");a&&(o=a.querySelector(".shipping_price"),n=a.querySelector(".nvg_shipping_cost")),"number"==typeof t&&0===t&&(t=""),o&&(o.innerHTML=t),n&&(n.innerHTML=t)}}},sendAjax:(e,t,o)=>{let a=Joomla.getOptions("nevigen_novaposhta");return window.NevigenNovaposhta.setPreloader(),new Promise((n,i)=>{if(!(a&&o&&e&&t))return i("Error ajax data"),!1;a.csrf&&o.set(a.csrf,1),o.set("task","NevigenNovaposhta."+t),Joomla.request({url:a.controller,method:e,data:o,onSuccess:e=>{let t;window.NevigenNovaposhta.removePreloader();try{t=JSON.parse(e)}catch(e){throw Error("Failed to parse JSON")}t&&!0===t.success?n(t):i(t)},onError:e=>{let t;window.NevigenNovaposhta.removePreloader();try{t=JSON.parse(e.response)}catch(e){throw Error("Failed to parse JSON")}i(t)}})})},setError:(e,t)=>{let o=Joomla.getOptions("nevigen_novaposhta_error_"+e);if(e&&(t||o)){t||(t=o.message);let a=document.querySelector('[data-nevigen-novaposhta-message="'+e+'"]');a&&Joomla.renderMessages({error:[t]},a)}},setPreloader:()=>{let e=document.querySelector('[data-nevigen-novaposhta="preloader"]');if(e||(e=document.querySelector('[nevigen-novaposhta="preloader"]')),e){let t=e.cloneNode(!0);t.setAttribute("data-active",1),document.body.appendChild(t),t.style.display=""}},removePreloader:()=>{let e=document.querySelector('[data-nevigen-novaposhta="preloader"][data-active]');e||(e=document.querySelector('[nevigen-novaposhta="preloader"][data-active]')),e&&e.remove()},setCookie:(e,t)=>{document.cookie=e+"="+t+"; path=/"},getCookie:e=>{if(document.cookie.length>0){let t=document.cookie.indexOf(e+"=");if(-1!==t){t=t+e.length+1;let o=document.cookie.indexOf(";",t);return-1===o&&(o=document.cookie.length),decodeURI(document.cookie.substring(t,o))}}return""},removeCookie:e=>{document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}},document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelector('input[name="sh_pr_method_id"]:checked');if(e){let t=e.getAttribute("data-shipping_id"),o=document.querySelector('input[name="params['+t+'][nevigen_novaposhta_postcode]"]');o&&(window.NevigenNovaposhta.initSelect(t,"warehouse"),window.NevigenNovaposhta.initSelect(t,"postomat"),window.NevigenNovaposhta.setError(t),o.value||(window.NevigenNovaposhta.removeCookie("nevigen_novaposhta_postcode"),window.NevigenNovaposhta.removeCookie("nevigen_novaposhta_postcode_send_warehouse"),window.NevigenNovaposhta.removeCookie("nevigen_novaposhta_postcode_send_postomat")))}let t=document.querySelector(".jshop #shipping_form");if(t){let e=t.querySelectorAll('input[name="sh_pr_method_id"]');e.length>0&&e.forEach(e=>{e.addEventListener("change",()=>{let o=t.querySelector('input[name="params['+e.value+'][nevigen_novaposhta_postcode]"]');if(o){let a=e.getAttribute("data-shipping_id");window.NevigenNovaposhta.setError(a);let n=t.querySelector('input[name="params['+e.value+'][nevigen_novaposhta_city]"]'),i=t.querySelector('input[name="params['+e.value+'][nevigen_novaposhta_warehouse]"]'),s=t.querySelector('input[name="params['+e.value+'][nevigen_novaposhta_postomat]"]');""===o.value?(n&&(n.value=""),i&&(i.value="",i.setAttribute("disabled",""),window.NevigenNovaposhta.initSelect(a,"warehouse",[])),s&&(s.value="",s.setAttribute("disabled",""),window.NevigenNovaposhta.initSelect(a,"postomat",[]))):(i&&""===i.value&&window.NevigenNovaposhta.getWarehouses(o,a),s&&""===s.value&&window.NevigenNovaposhta.getPostomat(o,a))}})})}}),document.addEventListener("nevigenOneStepCheckoutAfterSaveMethodsParams",e=>{let t=e.detail;if(t&&t.name&&t.name.includes("nevigen_novaposhta_")){let e=t.name.replace("nevigen_novaposhta_","");if(e&&"warehouse"!==e&&"postomat"!==e){let o="";if("postcode"===e?o="d_zip":"city"===e?o="d_city":"street"===e?o="d_street":"house"===e?o="d_home":"apartment"===e&&(o="d_apartment"),o){let e=new FormData;e.set("type","address"),e.set("saveformdata["+o+"]",t.element.value),e.set("method","nevigen_novaposhta"),window.NevigenOneStepCheckout().sendAjax("post","saveFormData",e).then(()=>{}).catch(e=>{window.NevigenNovaposhta.setError(t.id,e.message)})}}else"warehouse"!==e&&"postomat"!==e||window.NevigenNovaposhta.calculation(t.element,e,t.id,!0)}})})();